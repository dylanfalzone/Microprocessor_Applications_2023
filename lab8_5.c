/*
 * lab8_5.c
 *
 * Created: 4/18/2023 11:34:08 AM
 *  Author: dylan
 */ 
#include <avr/io.h>
#include <avr/interrupt.h>
#include "usart.h"

void tcc0_init();
void dac_init();
void dma_init();

volatile uint8_t flag;
uint8_t s_or_t;
volatile uint8_t button;

extern void clock_init(void);

uint16_t sine[256] = {
	0x800,0x832,0x864,0x896,0x8c8,0x8fa,0x92c,0x95e,
	0x98f,0x9c0,0x9f1,0xa22,0xa52,0xa82,0xab1,0xae0,
	0xb0f,0xb3d,0xb6b,0xb98,0xbc5,0xbf1,0xc1c,0xc47,
	0xc71,0xc9a,0xcc3,0xceb,0xd12,0xd39,0xd5f,0xd83,
	0xda7,0xdca,0xded,0xe0e,0xe2e,0xe4e,0xe6c,0xe8a,
	0xea6,0xec1,0xedc,0xef5,0xf0d,0xf24,0xf3a,0xf4f,
	0xf63,0xf76,0xf87,0xf98,0xfa7,0xfb5,0xfc2,0xfcd,
	0xfd8,0xfe1,0xfe9,0xff0,0xff5,0xff9,0xffd,0xffe,
	0xfff,0xffe,0xffd,0xff9,0xff5,0xff0,0xfe9,0xfe1,
	0xfd8,0xfcd,0xfc2,0xfb5,0xfa7,0xf98,0xf87,0xf76,
	0xf63,0xf4f,0xf3a,0xf24,0xf0d,0xef5,0xedc,0xec1,
	0xea6,0xe8a,0xe6c,0xe4e,0xe2e,0xe0e,0xded,0xdca,
	0xda7,0xd83,0xd5f,0xd39,0xd12,0xceb,0xcc3,0xc9a,
	0xc71,0xc47,0xc1c,0xbf1,0xbc5,0xb98,0xb6b,0xb3d,
	0xb0f,0xae0,0xab1,0xa82,0xa52,0xa22,0x9f1,0x9c0,
	0x98f,0x95e,0x92c,0x8fa,0x8c8,0x896,0x864,0x832,
	0x800,0x7cd,0x79b,0x769,0x737,0x705,0x6d3,0x6a1,
	0x670,0x63f,0x60e,0x5dd,0x5ad,0x57d,0x54e,0x51f,
	0x4f0,0x4c2,0x494,0x467,0x43a,0x40e,0x3e3,0x3b8,
	0x38e,0x365,0x33c,0x314,0x2ed,0x2c6,0x2a0,0x27c,
	0x258,0x235,0x212,0x1f1,0x1d1,0x1b1,0x193,0x175,
	0x159,0x13e,0x123,0x10a,0xf2,0xdb,0xc5,0xb0,
	0x9c,0x89,0x78,0x67,0x58,0x4a,0x3d,0x32,
	0x27,0x1e,0x16,0xf,0xa,0x6,0x2,0x1,
	0x0,0x1,0x2,0x6,0xa,0xf,0x16,0x1e,
	0x27,0x32,0x3d,0x4a,0x58,0x67,0x78,0x89,
	0x9c,0xb0,0xc5,0xdb,0xf2,0x10a,0x123,0x13e,
	0x159,0x175,0x193,0x1b1,0x1d1,0x1f1,0x212,0x235,
	0x258,0x27c,0x2a0,0x2c6,0x2ed,0x314,0x33c,0x365,
	0x38e,0x3b8,0x3e3,0x40e,0x43a,0x467,0x494,0x4c2,
	0x4f0,0x51f,0x54e,0x57d,0x5ad,0x5dd,0x60e,0x63f,
	0x670,0x6a1,0x6d3,0x705,0x737,0x769,0x79b,0x7cd
};
uint16_t tri[256] = {
	0x26,0x4d,0x73,0x99,0xc0,0xe6,0x10c,0x133,
	0x159,0x17f,0x1a6,0x1cc,0x1f2,0x218,0x23f,0x265,
	0x28b,0x2b2,0x2d8,0x2fe,0x325,0x34b,0x371,0x398,
	0x3be,0x3e4,0x40b,0x431,0x457,0x47e,0x4a4,0x4ca,
	0x4f1,0x517,0x53d,0x564,0x58a,0x5b0,0x5d6,0x5fd,
	0x623,0x649,0x670,0x696,0x6bc,0x6e3,0x709,0x72f,
	0x756,0x77c,0x7a2,0x7c9,0x7ef,0x815,0x83c,0x862,
	0x888,0x8af,0x8d5,0x8fb,0x922,0x948,0x96e,0x995,
	0x9bb,0x9e1,0xa07,0xa2e,0xa54,0xa7a,0xaa1,0xac7,
	0xaed,0xb14,0xb3a,0xb60,0xb87,0xbad,0xbd3,0xbfa,
	0xc20,0xc46,0xc6d,0xc93,0xcb9,0xce0,0xd06,0xd2c,
	0xd53,0xd79,0xd9f,0xdc5,0xdec,0xe12,0xe38,0xe5f,
	0xe85,0xeab,0xed2,0xef8,0xf1e,0xf45,0xf6b,0xf91,
	0xfb8,0xfde,0x1004,0x102b,0x1051,0x1077,0x109e,0x10c4,
	0x10ea,0x1111,0x1137,0x115d,0x1183,0x11aa,0x11d0,0x11f6,
	0x121d,0x1243,0x1269,0x1290,0x12b6,0x12dc,0x1303,0x1329,
	0x1303,0x12dc,0x12b6,0x1290,0x1269,0x1243,0x121d,0x11f6,
	0x11d0,0x11aa,0x1183,0x115d,0x1137,0x1111,0x10ea,0x10c4,
	0x109e,0x1077,0x1051,0x102b,0x1004,0xfde,0xfb8,0xf91,
	0xf6b,0xf45,0xf1e,0xef8,0xed2,0xeab,0xe85,0xe5f,
	0xe38,0xe12,0xdec,0xdc5,0xd9f,0xd79,0xd53,0xd2c,
	0xd06,0xce0,0xcb9,0xc93,0xc6d,0xc46,0xc20,0xbfa,
	0xbd3,0xbad,0xb87,0xb60,0xb3a,0xb14,0xaed,0xac7,
	0xaa1,0xa7a,0xa54,0xa2e,0xa07,0x9e1,0x9bb,0x995,
	0x96e,0x948,0x922,0x8fb,0x8d5,0x8af,0x888,0x862,
	0x83c,0x815,0x7ef,0x7c9,0x7a2,0x77c,0x756,0x72f,
	0x709,0x6e3,0x6bc,0x696,0x670,0x649,0x623,0x5fd,
	0x5d6,0x5b0,0x58a,0x564,0x53d,0x517,0x4f1,0x4ca,
	0x4a4,0x47e,0x457,0x431,0x40b,0x3e4,0x3be,0x398,
	0x371,0x34b,0x325,0x2fe,0x2d8,0x2b2,0x28b,0x265,
	0x23f,0x218,0x1f2,0x1cc,0x1a6,0x17f,0x159,0x133,
	0x10c,0xe6,0xc0,0x99,0x73,0x4d,0x26,0x0
};

uint8_t index =0;

int main(void)
{	
	//init everything
	clock_init();
	dac_init();
	tcc0_init();
	dma_init();
	usartd0_init2();
	s_or_t = 0;

	while (1)
	{
		if(flag ==1){
			if(button == 0x73){ //s
				//change to triangle
				if(s_or_t == 0){
					s_or_t =1;
					DMA.CH0.CTRLA = ~DMA_CH_ENABLE_bm;
					DMA.CH0.SRCADDR0 = (uint8_t)((uintptr_t)tri);
					DMA.CH0.SRCADDR1 = (uint8_t)(((uintptr_t)tri) >> 8);
					DMA.CH0.SRCADDR2 = (uint8_t)(((uint32_t)((uintptr_t)tri)) >>16);
					DMA.CH0.TRFCNT = (uint16_t)((sizeof(tri)));
					DMA.CH0.CTRLA |= DMA_CH_ENABLE_bm;
					USARTD0.CTRLA = USART_RXCINTLVL_HI_gc;
				}
				//change to sine
				else if(s_or_t ==1){
					s_or_t =0;
					DMA.CH0.CTRLA = ~DMA_CH_ENABLE_bm;
					DMA.CH0.SRCADDR0 = (uint8_t)((uintptr_t)sine);
					DMA.CH0.SRCADDR1 = (uint8_t)(((uintptr_t)sine) >> 8);
					DMA.CH0.SRCADDR2 = (uint8_t)(((uint32_t)((uintptr_t)sine)) >>16);
					DMA.CH0.TRFCNT = (uint16_t)((sizeof(sine)));
					DMA.CH0.CTRLA |= DMA_CH_ENABLE_bm;
					USARTD0.CTRLA = USART_RXCINTLVL_HI_gc;
				}
			}
			else if(button == 0x65) {//e
				TCC0.PER = 125000/1046.50;
				}
			else if(button == 0x34) {//4
				TCC0.PER = 125000/1108.73;
				}
			else if(button == 0x72) {//r
				TCC0.PER = 125000/1174.66;
				}
			else if(button == 0x35) {//5
				TCC0.PER = 125000/1244.51;
				}
			else if(button == 0x74) {//t
				TCC0.PER = 125000/1318.51;
				}
			else if(button == 0x79) {//y
				TCC0.PER = 125000/1396.91;
				}
			else if(button == 0x37) {//7
				TCC0.PER = 125000/1479.98;
				}
			else if(button == 0x75) {//u
				TCC0.PER = 125000/1567.98;
				}
			else if(button == 0x38) {//8
				TCC0.PER = 125000/1661.22;
				}
			else if(button == 0x69) {//i
				TCC0.PER = 125000/1760.00;
				}
			else if(button == 0x39) {//9
				TCC0.PER = 125000/1864.66;
				}
			else if(button == 0x6F) {//0
				TCC0.PER = 125000/1975.53;
				}
			else if(button == 0x70) {//p
				TCC0.PER = 125000/2093.00;
				}
			if(button!= 0x73){
				TCC0.CTRLA = TC_CLKSEL_DIV1_gc;
				TCD0.CTRLA = TC_CLKSEL_DIV256_gc;
			}
			flag =0;
		}
	}
}

void tcc0_init(){
	//tcc0 for timing
	TCC0.PER=0;
	TCC0.CTRLA = TC_CLKSEL_OFF_gc;
	TCC0.CTRLD = TC_EVACT_OFF_gc | TC_EVSEL_CH1_gc;
	//enable event
	EVSYS.CH0MUX = EVSYS_CHMUX_TCC0_OVF_gc;
	
	//tcd0 for interrupts
	TCD0.PER = 6250;
	TCD0.INTCTRLA = TC_OVFINTLVL_HI_gc;
	PMIC.CTRL = PMIC_HILVLEN_bm;
	sei();
	
	
}

void dac_init(){
	//vg
	PORTB.DIRCLR = 0b00000011;
	//CH1
	PORTA.OUTCLR = 0b00001000;
	PORTA.DIRSET = 0b00001000;
	//speaker
	PORTC.OUTSET = 0b10000000;
	PORTC.DIRSET = 0b10000000;
	
	//Just ch1
	DACA.CTRLB = DAC_CHSEL_SINGLE1_gc | DAC_CH1TRIG_bm;
	
	//arefb 2.5v
	DACA.CTRLC = DAC_REFSEL_AREFB_gc;
	
	//channel 0 trigger
	DACA.EVCTRL = 0b00000000;
	
	//CH1 AND ENABLE
	DACA.CTRLA=DAC_CH1EN_bm | DAC_ENABLE_bm;
}

void dma_init(){
	//reset periph
	DMA.CTRL |= DMA_RESET_bm;
	
	//2byte
	DMA.CH0.CTRLA = DMA_CH_SINGLE_bm | DMA_CH_BURSTLEN_2BYTE_gc | DMA_CH_REPEAT_bm;
	
	//source and dest type
	DMA.CH0.ADDRCTRL = DMA_CH_SRCRELOAD_BLOCK_gc | DMA_CH_SRCDIR_INC_gc| 
						DMA_CH_DESTRELOAD_BURST_gc | DMA_CH_DESTDIR_INC_gc;

	//configure trigger
	DMA.CH0.TRIGSRC = DMA_CH_TRIGSRC_EVSYS_CH0_gc;
	
	//source addr
	DMA.CH0.SRCADDR0 = (uint8_t)((uintptr_t)sine);
	DMA.CH0.SRCADDR1 = (uint8_t)(((uintptr_t)sine) >> 8);
	DMA.CH0.SRCADDR2 = (uint8_t)(((uint32_t)((uintptr_t)sine)) >>16);
	
	//dest addr
	DMA.CH0.DESTADDR0 = ((uint16_t)(&DACA.CH1DATA)&0XFF);
	DMA.CH0.DESTADDR1 = ((uint16_t)(&DACA.CH1DATA)&0XFF00) >> 8;
	DMA.CH0.DESTADDR2 = ((uint16_t)(&DACA.CH1DATA)&0XFF0000) >> 16;
	
	//transfer count
	DMA.CH0.TRFCNT = (uint16_t)((sizeof(sine)));
	
	//enable ch0
	DMA.CH0.CTRLA |=DMA_CH_ENABLE_bm;
	
	//enable DMA periph
	DMA.CTRL |= DMA_ENABLE_bm;
}

ISR(TCD0_OVF_vect){
	TCD0.CTRLA = TC_CLKSEL_OFF_gc;
	TCC0.CTRLA = TC_CLKSEL_OFF_gc;
	USARTD0.CTRLA = USART_RXCINTLVL_HI_gc;
}

ISR(USARTD0_RXC_vect){
	button = usartd0_in_char();
	USARTD0.CTRLA = USART_RXCINTLVL_OFF_gc;
	flag = 1;
}

	